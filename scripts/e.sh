model_path=/new_data/yanghq/models/deepseek-ai/DeepSeek-V2-Lite
gpuid=1

# model_path=/new_data/yanghq/models/deepseek-ai/DeepSeek-V2-Lite-Chat
# gpuid=0

model_path="${HOME}/$(echo "$model_path" | sed 's|^.*models/|models/|')"

method=auto

# args_list=(2,2 2,3 2,4 2,5 2,6 3,2 3,3 3,4 3,5 3,6 4,2 4,3 4,4 4,5 4,6 5,2 5,3 5,4 5,5 5,6 6,2 6,3 6,4 6,5 6,6 )
args_list=(2_2_2_1 2_2_2_6 2_2_2_11 2_2_4_1 2_2_4_6 2_2_4_11 2_2_6_1 2_2_6_6 2_2_6_11 2_4_2_1 2_4_2_6 2_4_2_11 2_4_4_1 2_4_4_6 2_4_4_11 2_4_6_1 2_4_6_6 2_4_6_11 2_6_2_1 2_6_2_6 2_6_2_11 2_6_4_1 2_6_4_6 2_6_4_11 2_6_6_1 2_6_6_6 2_6_6_11 4_2_2_1 4_2_2_6 4_2_2_11 4_2_4_1 4_2_4_6 4_2_4_11 4_2_6_1 4_2_6_6 4_2_6_11 4_4_2_1 4_4_2_6 4_4_2_11 4_4_4_1 4_4_4_6 4_4_4_11 4_4_6_1 4_4_6_6 4_4_6_11 4_6_2_1 4_6_2_6 4_6_2_11 4_6_4_1 4_6_4_6 4_6_4_11 4_6_6_1 4_6_6_6 4_6_6_11 6_2_2_1 6_2_2_6 6_2_2_11 6_2_4_1 6_2_4_6 6_2_4_11 6_2_6_1 6_2_6_6 6_2_6_11 6_4_2_1 6_4_2_6 6_4_2_11 6_4_4_1 6_4_4_6 6_4_4_11 6_4_6_1 6_4_6_6 6_4_6_11 6_6_2_1 6_6_2_6 6_6_2_11 6_6_4_1 6_6_4_6 6_6_4_11 6_6_6_1 6_6_6_6 6_6_6_11 )
args_list=(2_2_2_16 2_2_2_21 2_2_2_26 2_2_4_16 2_2_4_21 2_2_4_26 2_2_6_16 2_2_6_21 2_2_6_26 2_4_2_16 2_4_2_21 2_4_2_26 2_4_4_16 2_4_4_21 2_4_4_26 2_4_6_16 2_4_6_21 2_4_6_26 2_6_2_16 2_6_2_21 2_6_2_26 2_6_4_16 2_6_4_21 2_6_4_26 2_6_6_16 2_6_6_21 2_6_6_26 4_2_2_16 4_2_2_21 4_2_2_26 4_2_4_16 4_2_4_21 4_2_4_26 4_2_6_16 4_2_6_21 4_2_6_26 4_4_2_16 4_4_2_21 4_4_2_26 4_4_4_16 4_4_4_21 4_4_4_26 4_4_6_16 4_4_6_21 4_4_6_26 4_6_2_16 4_6_2_21 4_6_2_26 4_6_4_16 4_6_4_21 4_6_4_26 4_6_6_16 4_6_6_21 4_6_6_26 6_2_2_16 6_2_2_21 6_2_2_26 6_2_4_16 6_2_4_21 6_2_4_26 6_2_6_16 6_2_6_21 6_2_6_26 6_4_2_16 6_4_2_21 6_4_2_26 6_4_4_16 6_4_4_21 6_4_4_26 6_4_6_16 6_4_6_21 6_4_6_26 6_6_2_16 6_6_2_21 6_6_2_26 6_6_4_16 6_6_4_21 6_6_4_26 6_6_6_16 6_6_6_21 6_6_6_26 )

args_list=(2_2_2_1 2_2_2_11 2_2_4_11 2_2_6_11 2_4_2_1 2_4_2_6 2_4_2_11 2_4_4_1 2_4_4_6 2_4_4_11 2_4_6_1 2_4_6_6 2_6_2_11 2_6_4_1 2_6_4_6 2_6_4_11 2_6_6_6 2_6_6_11 4_2_4_1 4_2_4_6 4_2_6_1 4_2_6_6 4_4_2_1 4_4_2_6 4_4_2_11 4_4_4_11 4_4_6_11 4_6_2_1 4_6_2_6 4_6_2_11 4_6_4_1 4_6_4_6 4_6_4_11 4_6_6_1 4_6_6_11 6_2_2_1 6_2_2_6 6_2_2_11 6_2_4_1 6_2_4_6 6_2_6_1 6_4_2_1 6_4_2_6 6_4_2_11 6_4_4_1 6_4_4_6 6_4_6_1 6_4_6_6 6_4_6_11 6_6_2_6 6_6_4_1 6_6_4_6 6_6_4_11 6_6_6_1 )
args_list=(2_2_2_16 2_2_2_21 2_2_2_26 2_2_4_16 2_2_4_21 2_2_6_16 2_2_6_21 2_4_2_16 2_4_2_21 2_4_4_16 2_4_4_26 2_4_6_16 2_4_6_21 2_4_6_26 2_6_2_16 2_6_2_21 2_6_2_26 2_6_4_16 2_6_4_26 4_2_2_16 4_2_4_16 4_2_6_21 4_2_6_26 4_4_2_16 4_4_4_16 4_4_4_21 4_4_4_26 4_6_2_16 4_6_2_21 4_6_2_26 4_6_4_21 4_6_6_21 4_6_6_26 6_2_4_16 6_2_4_21 6_2_4_26 6_2_6_16 6_2_6_21 6_2_6_26 6_4_4_26 6_4_6_21 6_4_6_26 6_6_2_21 6_6_4_16 6_6_4_21 6_6_4_26 6_6_6_16 6_6_6_26 )

for args in ${args_list[@]}
do
    echo ${args}
    # echo ${model_path}

    python scripts/utils/modify_config.py \
        --model_path ${model_path} \
        --method ${method} \
        --args ${args}

    ######

    tasks=arc_challenge,arc_easy,boolq,openbookqa,rte,winogrande

    model_args=pretrained=${model_path},trust_remote_code=True
    # model_args=${model_args},tp_size=2,chunked_prefill_size=4096
    model_args=${model_args},enable_p2p_check=True,disable_cuda_graph=True
    model_args=${model_args},mem_fraction_static=0.7
    # model_args=${model_args},

    # HF_DATASETS_TRUST_REMOTE_CODE=True \
    CUDA_VISIBLE_DEVICES=$gpuid \
    lm_eval --model sglang \
        --model_args ${model_args} \
        --tasks ${tasks} \
        --batch_size 512 \
        --trust_remote_code \
        --num_fewshot 0 \
        --output_path ${HOME}/data/lme/${method}/${args}.jsonl
        # --limit 256 \
    
    sleep 1

done